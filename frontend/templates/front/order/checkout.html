{% extends "front/base.html" %}
{% load static %}
{% block custom_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .select2-container--default .select2-selection--single{
        min-height: 4.4rem;
        padding: 6px;
        border: 1px solid #ededed;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow{
        top: 8px;
    }
</style>
{%endblock custom_css %}
{% block content %}
<!-- Start of Breadcrumb -->
<nav class="breadcrumb-nav">
  <div class="container">
    <ul class="breadcrumb shop-breadcrumb bb-no">
      <li class="passed">
        <a href="#" style="pointer-events: none">Shopping Cart</a>
      </li>
      <li class="active">
        <a href="#" style="pointer-events: none">Checkout</a>
      </li>
      <li><a href="#" style="pointer-events: none">Order Complete</a></li>
    </ul>
  </div>
</nav>
<!-- End of Breadcrumb -->
<!-- Start of PageContent -->
<div class="page-content">
  <div class="container">
    <form
      class="form checkout-form"
      action="{% url 'place_order' %}"
      method="post"
    >
      {% csrf_token %}
      <div class="row mb-9">
        <div class="col-lg-7 pr-lg-4 mb-4">
          <h3 class="title billing-title text-uppercase ls-10 pt-1 pb-3 mb-0">
            Billing Details
          </h3>
          <div class="row gutter-sm">
            <div class="col-xs-6">
              <label>Email address</label>
              <input
                type="email"
                class="form-control form-control-md"
                name="email"
              />
            </div>
            <div class="col-xs-6">
              <label>Phone Number *</label>
              <input
                type="number"
                class="form-control form-control-md"
                name="email"
                required
              />
            </div>
          </div>
          <div class="row gutter-sm">
            <div class="col-xs-6">
              <div class="form-group">
                <label>First name *</label>
                <input
                  type="text"
                  class="form-control form-control-md"
                  name="firstname"
                  required
                />
              </div>
            </div>
            <div class="col-xs-6">
              <div class="form-group">
                <label>Last name *</label>
                <input
                  type="text"
                  class="form-control form-control-md"
                  name="lastname"
                  required
                />
              </div>
            </div>
          </div>
          <div class="row gutter-sm">
            <div class="form-group col-6 mb-5">
              <label>District *</label>
              <select
                id="district"
                name="district"
                class="form-control form-control-md select2"
                required
              >
                <option value="">Select District</option>
              </select>
            </div>
            <div class="form-group col-6 mb-5">
              <label>Thana / Upazila *</label>
              <select
                id="thana"
                name="thana"
                class="form-control form-control-md select2"
                required
              >
                <option value="">Select Thana</option>
              </select>
            </div>
          </div>
          <div class="form-group mb-5">
            <label>Street address *</label>
            <input
              type="text"
              placeholder="House number and street name"
              class="form-control form-control-md mb-2"
              name="street-address-1"
              required
            />
          </div>
          <div class="row gutter-sm">
            <div class="form-group col-6">
              <label>Apartment, suite, unit, etc. (optional)</label>
                <input
                    type="text"
                    placeholder="Apartment, suite, unit, etc. (optional)"
                    class="form-control form-control-md"
                    name="street-address-2"
                />
            </div>
            <div class="form-group col-6">
              <label>ZIP *</label>
              <input
                type="text"
                class="form-control form-control-md"
                name="zip"
                required
              />
            </div>
          </div>
        </div>
        <div class="col-lg-5 mb-4 sticky-sidebar-wrapper">
          <div class="order-summary-wrapper sticky-sidebar">
            <h3 class="title text-uppercase ls-10">Your Order</h3>
            <div class="order-summary">
              <table class="order-table">
                <thead>
                  <tr>
                    <th colspan="2"><b>Product</b></th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in cart_items %}
                  <tr class="bb-no">
                    <td class="product-name">
                      {{ item.name }} <i class="fas fa-times"></i>
                      <span class="product-quantity">{{ item.quantity }}</span>
                    </td>
                    <td class="product-total">
                      ৳ {{ item.subtotal|floatformat:2 }}
                    </td>
                  </tr>
                  {% endfor %}
                  <tr class="cart-subtotal bb-no">
                    <td><b>Subtotal</b></td>
                    <td>
                      <b>৳{{ total_price_without_discount|floatformat:2 }}</b>
                    </td>
                  </tr>
                  <tr class="cart-subtotal bb-no">
                    <td><b>Discount</b></td>
                    <td><b>৳{{ cart_discount_total }}</b></td>
                  </tr>
                    <tr class="shipping-cost bb-no">
                        <td><b>Shipping</b></td>
                        <td><b>৳<span id="shipping_cost">{{ shipping_cost|floatformat:2 }}</span></b></td>
                    </tr>
                </tbody>
                <tfoot>
                  <tr class="shipping-methods"></tr>
                  
                    <tr class="order-total">
                        <th><b>Total</b></th>
                        <td><b>৳<span id="cart_total">{{ cart_total|floatformat:2 }}</span></b></td>
                    </tr>
                </tfoot>
              </table>
              <div class="payment-methods" id="payment_method">
                <h4 class="title font-weight-bold ls-25 pb-0 mb-1">
                  Payment Methods
                </h4>
                <div class="accordion payment-accordion">
                  <div class="card">
                    <div class="card-header">
                      <a href="#cash-on-delivery" class="collapse"
                        >Direct Bank Transfor</a
                      >
                    </div>
                    <div id="cash-on-delivery" class="card-body expanded">
                      <p class="mb-0">
                        Make your payment directly into our bank account. Please
                        use your Order ID as the payment reference. Your order
                        will not be shipped until the funds have cleared in our
                        account.
                      </p>
                    </div>
                  </div>
                  <div class="card">
                    <div class="card-header">
                      <a href="#delivery" class="expand">Cash on delivery</a>
                    </div>
                    <div id="delivery" class="card-body collapsed">
                      <p class="mb-0">Pay with cash upon delivery.</p>
                    </div>
                  </div>
                </div>
              </div>
              {% if has_own_products %}
              <div
                style="
                  background-color: rgba(255, 0, 0, 0.1);
                  color: red;
                  padding: 10px;
                  border-radius: 5px;
                "
              >
                You have your own products in the cart. Please remove them to
                proceed to checkout.
              </div>
              {% else %}
              <div class="form-group place-order pt-6">
                <button
                  type="submit"
                  class="btn btn-dark btn-block btn-rounded"
                >
                  Place Order
                </button>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- End of PageContent -->
{% endblock content %}
 {% block custom_js %}
 <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
    $('.select2').select2();

    const districtSelect = $("#district");
    const thanaSelect = $("#thana");

    // Step 1: Load all districts
    fetch("https://bdapi.vercel.app/api/v.1/district")
        .then(res => res.json())
        .then(data => {
            if (data && data.data) {
                data.data.forEach(district => {
                    districtSelect.append(
                        $("<option>", {
                            value: district.name,
                            "data-id": district.id,
                            text: district.name
                        })
                    );
                });
            }
        })
        .catch(err => console.error("Error loading districts:", err));

    // Step 2: Change event for Select2
    districtSelect.on("change", function () {
        const districtName = this.value;
        console.log("District selected:", this.value);
        thanaSelect.empty().append('<option value="">Select Thana</option>');

        console.log('district name: ', districtName)

        const districtId = $(this).find(":selected").data("id");
        if (!districtId) return;

        fetch(`https://bdapi.vercel.app/api/v.1/upazilla/${districtId}`)
        .then(res => res.json())
        .then(data => {
            console.log("Upazila API response:", data);
            if (data && data.data && Array.isArray(data.data)) {
                data.data.forEach(thana => {
                    thanaSelect.append(
                        $("<option>", {
                            value: thana.name,
                            text: thana.name
                        })
                    );
                });
            } else {
                thanaSelect.html('<option value="">No thanas available</option>');
            }
        })
        .catch(err => {
            console.error("Error loading thanas:", err);
            thanaSelect.html('<option value="">Error loading thanas</option>');
        });



        // Fetch updated shipping cost from Django view
        fetch(`/get-shipping-cost/?district=${encodeURIComponent(districtName)}`)
            .then(res => res.json())
            .then(data => {
                console.log("Updated cart with shipping:", data);
                
                // Update shipping cost
                const shippingEl = document.getElementById("shipping_cost");
                if (shippingEl) {
                    shippingEl.textContent = parseFloat(data.shipping_cost).toFixed(2);
                }

                // Update total
                const totalEl = document.getElementById("cart_total");
                if (totalEl) {
                    totalEl.textContent = parseFloat(data.cart_total).toFixed(2);
                }
            })
            .catch(err => console.error("Error fetching shipping cost:", err));
    });
});
</script>
{% endblock custom_js %}